<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>IO Sano</title>

  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  
  <meta name="apple-mobile-web-app-title" content="IO Sano"/>
  <meta name="application-name" content="IO Sano"/>
  <meta name="mobile-web-app-capable" content="yes"/>
<meta name="theme-color" content="#667eea"/>
  <link rel="manifest" href="manifest.webmanifest"/>

  <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120.png"/>
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png"/>
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167.png"/>
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png"/>
    <link rel="apple-touch-icon" href="icons/icon-180.png"/>
<link type="image/png" rel="icon" sizes="192x192" href="icons/icon-192.png"/>
  <link type="image/png" rel="icon" sizes="512x512" href="icons/icon-512.png"/>

  <style>

    :root {
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: rgba(255, 255, 255, 0.96);
      --card-border: rgba(255, 255, 255, 0.55);

      --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --danger-grad: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      --success-grad: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --orange-grad: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --silver-grad: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      --picking-grad: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);

      --text-dark: #1f2937;
      --text-muted: #6b7280;

      --radius-lg: 20px;
      --radius-md: 12px;

      --shadow-soft: 0 8px 28px rgba(31, 38, 135, 0.12);

      --cell-w: 110pt;
      --cell-h: 55pt;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, system-ui, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    html, body { height: 100%; }

    body {
      margin: 0;
      background: var(--bg-gradient);
      color: var(--text-dark);
      line-height: 1.6;
      min-height: 100vh;
      padding-bottom: 80px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    main {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: rgba(255, 255, 255, 0.14);
      border-bottom: 1px solid rgba(255,255,255,0.28);
      padding: 1.2rem 1.5rem;
      padding-top: calc(1.2rem + env(safe-area-inset-top));
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.12);
      box-shadow: 0 2px 10px rgba(0,0,0,0.10);
    }
    header h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      padding: 20px;
      position: sticky;
      top: calc(70px + env(safe-area-inset-top));
      z-index: 40;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab {
      flex: 1;
      min-width: 100px;
      text-align: center;
      padding: 12px 15px;
      border-radius: 40px;
      border: 2px solid rgba(255,255,255,0.10);
      background: rgba(255, 255, 255, 0.20);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.12s ease, background-color 0.15s ease, color 0.15s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.10);
      user-select: none;
      white-space: nowrap;
    }
    .tab.active {
      background: white;
      color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      border-color: white;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-soft);
      transition: transform 0.12s ease;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    input[type=text], input[type=number], select {
      width: 100%;
      padding: 14px 18px;
      font-size: 1rem;
      border: 2px solid #c7d2fe;
      border-radius: var(--radius-md);
      background: #e5edff;
      color: #1f2937;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.08);
      font-weight: 500;
      outline: none;
    }

    button {
      padding: 12px 22px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      transition: transform 0.10s ease, opacity 0.12s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.3px;
      white-space: nowrap;
      user-select: none;
      touch-action: manipulation;
    }
    button:active { transform: scale(0.97); }

    button:not(.ghost):not(.alt):not(.danger):not(.action-btn):not(.remove-grid):not(.go-to-map):not(.secondary):not(.pick-btn) {
      background: var(--primary-grad);
      color: white;
    }
    
    button.pick-btn {
        background: var(--picking-grad);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.25);
    }

    button.ghost { background: white; border: 2px solid #e5e7eb; color: #4b5563; }
    button.secondary { background: var(--silver-grad); border: 2px solid #d1d5db; color: #374151; }
    button.danger { background: var(--danger-grad); color: white; }
    button.alt, button.add-grid { background: var(--success-grad); color: white; }
    button.remove-grid { background: var(--orange-grad); color: white; }
    button.go-to-map { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; }

    .list-item {
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 20px;
      border-radius: var(--radius-md);
      background: white;
      margin-bottom: 14px;
      border-left: 5px solid #e5e7eb;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    @media (min-width: 600px) {
      .list-item { flex-direction: row; align-items: center; justify-content: space-between; }
    }

    .grid-wrap { overflow-x: auto; padding-bottom: 15px; }
    .grid { display: grid; gap: 12px; grid-auto-rows: var(--cell-h); }
    .grid-frame{
      --axis-w: 34px; --axis-h: 28px;
      display: grid;
      grid-template-columns: var(--axis-w) auto var(--axis-w);
      grid-template-rows: var(--axis-h) auto var(--axis-h);
      gap: 12px;
    }
    .axis { display: grid; gap: 12px; }
    .axis-cell {
      display: flex; align-items: center; justify-content: center;
      border-radius: 10px; font-weight: 800; font-size: 13px;
      color: #4338ca; background: rgba(102, 126, 238, 0.16);
      border: 1px solid rgba(102, 126, 238, 0.30);
    }

    .cell {
      width: var(--cell-w); height: var(--cell-h);
      border-radius: 12px; border: 3px solid rgba(0,0,0,0.06);
      background: linear-gradient(135deg, rgba(255,255,255,0.92) 0%, rgba(249,250,251,0.92) 100%);
      display: flex; flex-direction: column; align-items: center; padding: 8px; text-align: center;
    }
    .cell.occ { border-color: #8b5cf6; border-bottom-width: 5px; }

    .tagline { margin-top: 8px; display:flex; gap:10px; flex-wrap:wrap; }
    .tag {
      padding: 6px 12px; border-radius: 999px; font-size: 0.82rem; font-weight: 800;
      background: #fff; border: 2px solid #e5e7eb;
    }
    .tag.red { border-color: #ef4444; color:#991b1b; }
    .tag.yellow { border-color: #f59e0b; color:#92400e; }
    .tag.green { border-color: #10b981; color:#065f46; }
    .tag.skull { border-color: #000; color:#111827; }

    dialog {
      background: white; border-radius: 24px; padding: 32px;
      width: 450px; max-width: 92%; border: none; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

<header>
  <div><h1>IO Sano</h1></div>
  <button class="ghost" id="undoBtn" style="display:none; padding: 8px 16px; font-size: 0.85rem; border-radius: 25px;">‚Ü∂ Annulla</button>
</header>

<nav class="tabs">
  <button class="tab active" id="tab-lista">Lista</button>
  <button class="tab" id="tab-mappa">Mappa</button>
  <button class="tab" id="tab-picking">Picking</button>
  <button class="tab" id="tab-stats">Stats</button>
</nav>

<main>
  <section id="view-lista">
    <div class="card">
      <h3 style="margin-top:0">Nuovo Inserimento</h3>
      
        <div style="display:flex; gap:15px; flex-wrap:wrap">
            <div style="flex:1; min-width:200px">
              <label>Descrizione</label>
              <input id="pName" type="text">
            </div>
            <div style="flex:1; min-width:150px">
              <label>Lotto</label>
              <input id="pLot" type="text">
            </div>
            <div style="flex:1; min-width:150px">
              <label>Scadenza (ES: GEN/26)</label>
              <input id="pExpiry" type="text">
            </div>
        </div>

        <div style="margin-top:20px; text-align:right">
            <button class="pick-btn" id="savePickBtn">Aggiungi a Picking</button>
        </div>
    </div>
    <div class="card">
        <h3>Lista Picking (In Uscita)</h3>
        <div id="listPicking"></div>
    </div>
  </section>

  <section id="view-stats" style="display:none">
    <div class="card">
        <h3>Riepilogo</h3>
        <div id="statsSummary" style="font-weight:bold"></div>
    </div>
    <div class="card">
        <div id="statsDetails"></div>
    </div>
  </section>
</main>

<dialog id="cellDialog">
  <form method="dialog">
    <h3 id="cellTitle">Dettaglio Cella</h3>
    <div id="cellInfo"></div>
    <div id="cellActions" style="display:flex; flex-direction:column; gap:10px; margin-top:20px"></div>
    <button class="ghost" style="width:100%; margin-top:10px">Chiudi</button>
  </form>
</dialog>

<div id="notification-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center">
    <div class="card" style="width:300px; text-align:center">
        <h3 id="modalTitle"></h3>
        <p id="modalMsg"></p>
        <button id="modalConfirm">OK</button>
    </div>
</div>

<script>
(() => {
    // --- Stato ---
    let products = JSON.parse(localStorage.getItem('wh_v7_prod') || '[]');
    let undoStack = [];
    const rows = 7, cols = 10;

    const $ = id => document.getElementById(id);

    // --- Utils ---
    const save = () => {
        localStorage.setItem('wh_v7_prod', JSON.stringify(products));
        render();
    };

    const logAction = () => {
        undoStack.push(JSON.stringify(products));
        if(undoStack.length > 10) undoStack.shift();
        $('undoBtn').style.display = 'block';
    };

    const getStatus = (exp) => {
        if(!exp) return null;
        const months = {GEN:0,FEB:1,MAR:2,APR:3,MAG:4,GIU:5,LUG:6,AGO:7,SET:8,OTT:9,NOV:10,DIC:11};
        const m = exp.toUpperCase().match(/(GEN|FEB|MAR|APR|MAG|GIU|LUG|AGO|SET|OTT|NOV|DIC)[\s\/-]?(\d{2})/);
        if(!m) return null;
        const d = new Date(2000 + parseInt(m[2]), months[m[1]] + 1, 0);
        const diff = Math.ceil((d - new Date()) / 86400000);
        if(diff < 0) return {cls:'skull', lbl:'‚ò†Ô∏è Scaduto'};
        if(diff < 180) return {cls:'red', lbl:'üî¥ < 6 mesi'};
        if(diff < 270) return {cls:'yellow', lbl:'üü° < 9 mesi'};
        return {cls:'green', lbl:'üü¢ OK'};
    };

    // --- Core Logic ---
    const addProduct = (name, lot, exp, area = 'wh') => {
        if(!name && !lot) return;
        logAction();
        products.unshift({
            id: Date.now(),
            name, lot, expiryText: exp,
            area, // 'wh' = magazzino, 'pick' = picking
            row: null, col: null,
            date: new Date().toISOString()
        });
        save();
    };

    const moveProduct = (id, target) => {
        logAction();
        const p = products.find(x => x.id == id);
        if(p) {
            p.area = target;
            p.row = null; p.col = null;
        }
        save();
    };

    const deleteProduct = (id) => {
        logAction();
        products = products.filter(x => x.id != id);
        save();
    };

    
    // --- Conferme (native) ---
    const confirmMoveToPick = (id) => {
        const p = products.find(x => x.id == id);
        if(!p) return;
        const ok = confirm(
            `Mettere in PRELIEVO questo prodotto?

` +
            `Descrizione: ${p.name || 'Senza Nome'}
` +
            `Lotto: ${p.lot || '-'}
` +
            `Scadenza: ${p.expiryText || '-'}`
        );
        if(ok) moveProduct(id, 'pick');
    };

    const confirmMoveToWh = (id) => {
        const p = products.find(x => x.id == id);
        if(!p) return;
        const ok = confirm(
            `Ripristinare questo prodotto in LISTA?

` +
            `Descrizione: ${p.name || 'Senza Nome'}
` +
            `Lotto: ${p.lot || '-'}
` +
            `Scadenza: ${p.expiryText || '-'}`
        );
        if(ok) moveProduct(id, 'wh');
    };

    const confirmDelete = (id) => {
        const p = products.find(x => x.id == id);
        if(!p) return;
        const ok = confirm(
            `ELIMINARE questo prodotto?

` +
            `Descrizione: ${p.name || 'Senza Nome'}
` +
            `Lotto: ${p.lot || '-'}`
        );
        if(ok) deleteProduct(id);
    };

    const confirmShelf = (p) => {
        if(!p) return;
        const ok = confirm(
            `Mettere a SCAFFALE (liberare la cella)?

` +
            `Descrizione: ${p.name || 'Senza Nome'}
` +
            `Lotto: ${p.lot || '-'}`
        );
        if(ok) {
            logAction();
            p.row = null; p.col = null;
            save();
        }
    };

    // Inserimento diretto in una cella (prodotti a terra)
    const addProductAtCell = (name, lot, exp, r, c) => {
        if(!name || !lot || !exp) return;
        if(products.some(x => x.area === 'wh' && x.row === r && x.col === c)) return;
        logAction();
        products.unshift({
            id: Date.now(),
            name, lot, expiryText: exp,
            area: 'wh',
            row: r, col: c,
            date: new Date().toISOString()
        });
        save();
    };
// --- Rendering ---
    const render = () => {
        const query = $('search').value.toLowerCase();
        const lists = { 
            unplaced: $('listUnplaced'), 
            placed: $('listPlaced'), 
            picking: $('listPicking') 
        };
        
        Object.values(lists).forEach(l => l.innerHTML = '');

        products.forEach(p => {
            if(query && !p.name.toLowerCase().includes(query) && !p.lot.toLowerCase().includes(query)) return;

            const item = document.createElement('div');
            item.className = 'list-item';
            const stat = getStatus(p.expiryText);
            
            item.innerHTML = `
                <div>
                    <strong>${p.name || 'Senza Nome'}</strong><br>
                    <small>Lotto: ${p.lot || '-'}</small>
                    <div class="tagline">
                        ${stat ? `<span class="tag ${stat.cls}">${stat.lbl}</span>` : ''}
                        ${p.row !== null ? `<span class="tag" style="background:#e5edff">üìç R${p.row+1} C${p.col+1}</span>` : ''}
                    </div>
                </div>
                <div style="display:flex; gap:5px; flex-wrap:wrap">
                    ${p.area === 'wh' ? `<button class="pick-btn" onclick="confirmPick(${p.id})">Metti in Prelievo</button>` : `<button class="secondary" onclick="confirmRestore(${p.id})">Ripristina</button>`}
                    ${p.area === 'wh' && p.row === null ? `<button class="add-grid" onclick="posiziona(${p.id})">Posiziona</button>` : ''}
                    <button class="danger" onclick="confermaElimina(${p.id})">Elimina</button>
                </div>
            `;

            if(p.area === 'pick') lists.picking.appendChild(item);
            else if(p.row !== null) lists.placed.appendChild(item);
            else lists.unplaced.appendChild(item);
        });

        renderGrid();
        renderStats();
    };

    const renderGrid = () => {
        const grid = $('grid');
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `repeat(${cols}, var(--cell-w))`;

        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                const p = products.find(x => x.area === 'wh' && x.row === r && x.col === c);
                const cell = document.createElement('div');
                cell.className = 'cell' + (p ? ' occ' : '');
                cell.innerHTML = p ? `<strong>${p.name}</strong><br><small>${p.lot}</small>` : '';
                cell.onclick = () => openCell(r, c, p);
                grid.appendChild(cell);
            }
        }
    };

    const renderStats = () => {
        const total = products.length;
        const inPick = products.filter(x => x.area === 'pick').length;
        const expired = products.filter(x => getStatus(x.expiryText)?.cls === 'skull').length;

        $('statsSummary').innerHTML = `
            Prodotti Totali: ${total} | In Picking: ${inPick} | Scaduti: ${expired}
        `;
    };

    // --- Handlers Esposti ---
    // Azioni "grezze" (non usare direttamente dalla UI)
    window.moveToPick = (id) => moveProduct(id, 'pick');
    window.moveToWh = (id) => moveProduct(id, 'wh');
    window.elimina = (id) => deleteProduct(id);

    // Azioni UI (con conferma)
    window.confirmPick = (id) => confirmMoveToPick(id);
    window.confirmRestore = (id) => confirmMoveToWh(id);
    window.confermaElimina = (id) => confirmDelete(id);
window.posiziona = (id) => {
        const col = prompt("In quale colonna vuoi metterlo? (1-10)");
        if(!col || col < 1 || col > 10) return;
        const c = col - 1;
        const row = Array.from({length:rows}, (_,i)=>i).find(r => !products.some(p => p.row === r && p.col === c));
        if(row === undefined) return alert("Colonna piena!");
        logAction();
        const p = products.find(x => x.id == id);
        p.row = row; p.col = c;
        save();
    };

    window.openCell = (r, c, p) => {
        const dialog = $('cellDialog');
        $('cellTitle').innerText = `Cella R${r+1} C${c+1}`;
        const actions = $('cellActions');
        actions.innerHTML = '';
        
        if(p) {
            $('cellInfo').innerHTML = `<strong>${p.name}</strong><br>Lotto: ${p.lot}`;
            const btnPick = document.createElement('button');
            btnPick.className = 'pick-btn';
            btnPick.innerText = 'Metti in Prelievo';
            btnPick.onclick = () => { confirmMoveToPick(p.id); dialog.close(); };
            
            const btnLibera = document.createElement('button');
            btnLibera.className = 'remove-grid';
            btnLibera.innerText = 'Metti a scaffale';
            btnLibera.onclick = () => { confirmShelf(p); dialog.close(); };

            actions.appendChild(btnPick);
            actions.appendChild(btnLibera);
        } else {
            $('cellInfo').innerHTML = `
                <div style="margin-top:6px; color:#6b7280; font-weight:600">Cella Vuota</div>
                <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px">
                    <div>
                        <label style="margin-bottom:6px">Descrizione</label>
                        <input id="cellName" type="text" autocomplete="off">
                    </div>
                    <div>
                        <label style="margin-bottom:6px">Lotto</label>
                        <input id="cellLot" type="text" autocomplete="off">
                    </div>
                    <div>
                        <label style="margin-bottom:6px">Scadenza (ES: GEN/26)</label>
                        <input id="cellExpiry" type="text" autocomplete="off">
                    </div>
                </div>
            `;

            const btnAdd = document.createElement('button');
            btnAdd.className = 'add-grid';
            btnAdd.innerText = 'Inserisci qui';
            btnAdd.onclick = () => {
                const name = (document.getElementById('cellName')?.value || '').trim();
                const lot = (document.getElementById('cellLot')?.value || '').trim();
                const exp = (document.getElementById('cellExpiry')?.value || '').trim();
                if(!name || !lot || !exp) {
                    alert('Descrizione, Lotto e Scadenza sono obbligatori.');
                    return;
                }
                addProductAtCell(name, lot, exp, r, c);
                dialog.close();
            };
            actions.appendChild(btnAdd);
        }
        dialog.showModal();
    };

    // --- Events ---
    $('saveBtn').onclick = () => {
        const name = $('name').value.trim();
        const lot = $('lot').value.trim();
        const exp = $('expiry').value.trim();
        if(!lot || !exp) {
            alert('Lotto e Scadenza sono obbligatori.');
            return;
        }
        if(!name) {
            alert('La Descrizione √® obbligatoria.');
            return;
        }
        addProduct(name, lot, exp);
        $('name').value = ''; $('lot').value = ''; $('expiry').value = '';
    };

    $('savePickBtn').onclick = () => {
        const name = $('pName').value.trim();
        const lot = $('pLot').value.trim();
        const exp = ($('pExpiry')?.value || '').trim();
        if(!lot || !exp) {
            alert('Lotto e Scadenza sono obbligatori.');
            return;
        }
        if(!name) {
            alert('La Descrizione √® obbligatoria.');
            return;
        }
        addProduct(name, lot, exp, 'pick');
        $('pName').value = ''; $('pLot').value = ''; if($('pExpiry')) $('pExpiry').value = '';
    };

    $('undoBtn').onclick = () => {
        if(undoStack.length) {
            products = JSON.parse(undoStack.pop());
            save();
            if(!undoStack.length) $('undoBtn').style.display = 'none';
        }
    };

    $('search').oninput = render;

    // Navigation
    const tabs = ['lista', 'mappa', 'picking', 'stats'];
    tabs.forEach(t => {
        $(`tab-${t}`).onclick = () => {
            tabs.forEach(x => {
                $(`view-${x}`).style.display = x === t ? 'block' : 'none';
                $(`tab-${x}`).classList.toggle('active', x === t);
            });
            if(t === 'mappa') renderGrid();
        };
    });

    // Init Assi
    const initAxis = () => {
        const createCells = (n, target) => {
            for(let i=1; i<=n; i++) {
                const d = document.createElement('div');
                d.className = 'axis-cell'; d.innerText = i;
                $(target).appendChild(d);
            }
        };
        createCells(cols, 'axisTop'); createCells(cols, 'axisBottom');
        createCells(rows, 'axisLeft'); createCells(rows, 'axisRight');
        $('axisTop').style.gridTemplateColumns = `repeat(${cols}, var(--cell-w))`;
        $('axisBottom').style.gridTemplateColumns = `repeat(${cols}, var(--cell-w))`;
    };

    initAxis();
    render();
})();
</script>
</body>
</html>